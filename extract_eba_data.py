# -*- coding: utf-8 -*-
"""extract_eba_data.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1q-uATpFVd3FEs4f_xdY3oC8CtxqmDWfG
"""

import pandas as pd
import numpy as np

# =====================================================
# CONFIG
# =====================================================

INPUT_FILE = "tr_oth.csv"     # EBA 'Other Templates' CSV
TARGET_PERIOD = 202309        # The period you selected

OUTPUT_MAIN  = "eba_202309_dataset.csv"
OUTPUT_AUDIT = "eba_202309_audit.csv"

# =====================================================
# LOAD DATA
# =====================================================

df = pd.read_csv(INPUT_FILE)

# Clean and normalize column names
df.columns = [c.strip() for c in df.columns]

# Auto-detect the important columns
col_bank   = next(c for c in df.columns if c.lower() in ["lei", "lei_code", "bank", "entity", "institution_name", "name"])
col_amount = next(c for c in df.columns if any(x in c.lower() for x in ["amount","value","amt","obs"]))
col_label  = next(c for c in df.columns if "label" in c.lower())
col_period = next(c for c in df.columns if "period" in c.lower())

# Standardize naming
df["Bank"]   = df[col_bank].astype(str)
df["Label"]  = df[col_label].astype(str)
df["Amount"] = pd.to_numeric(df[col_amount], errors="coerce")
df["Period"] = pd.to_numeric(df[col_period], errors="coerce")

# =====================================================
# FILTER TARGET PERIOD (202309)
# =====================================================

df_period = df[df["Period"] == TARGET_PERIOD].copy()

# =====================================================
# DEFINE LABEL PATTERNS (STRONG & SAFE)
# =====================================================

# Interest expense
pat_x1 = [
    "interest expense",
    "interest expenses",
    "interest and similar expenses",
]

# Admin + depreciation + amortization
pat_admin = [
    "administrative expenses",
    "general and administrative expenses"
]

pat_depr = ["depreciation"]
pat_amor = ["amortisation", "amortization"]

# Interest income
pat_y1 = [
    "interest income",
    "interest and similar income"
]

# Non-interest income components
pat_fee_net = ["net fee and commission income"]
pat_fee_inc = ["fee and commission income"]
pat_fee_exp = ["fee and commission expense"]

pat_trading = [
    "net trading income",
    "gains or losses on financial instruments",
    "fair value through profit or loss"
]

pat_div = ["dividend income"]

# Total assets
pat_assets = ["total assets"]


# =====================================================
# HELPER: match labels by substring (case insensitive)
# =====================================================
def match_any(label, patterns):
    label_lower = label.lower()
    return any(p.lower() in label_lower for p in patterns)

# =====================================================
# BUILD COMPONENT TABLE
# =====================================================

records = []

for _, row in df_period.iterrows():
    lab = row["Label"]
    amt = row["Amount"]
    bank = row["Bank"]

    var = None

    # x1: interest expense
    if match_any(lab, pat_x1):
        var = "x1_interest_expense"

    # x2: admin + depr + amort
    elif match_any(lab, pat_admin):
        var = "x2_admin"
    elif match_any(lab, pat_depr):
        var = "x2_depr"
    elif match_any(lab, pat_amor):
        var = "x2_amor"

    # y1: interest income
    elif match_any(lab, pat_y1):
        var = "y1_interest_income"

    # y2: fees
    elif match_any(lab, pat_fee_net):
        var = "y2_fee_net"
    elif match_any(lab, pat_fee_inc):
        var = "y2_fee_inc"
    elif match_any(lab, pat_fee_exp):
        var = "y2_fee_exp"

    # y2: trading
    elif match_any(lab, pat_trading):
        var = "y2_trading"

    # y2: dividends
    elif match_any(lab, pat_div):
        var = "y2_div"

    # x3: total assets
    elif match_any(lab, pat_assets):
        var = "x3_total_assets"

    if var:
        records.append({
            "Bank": bank,
            "Variable": var,
            "Amount": amt,
            "Label": lab
        })

audit = pd.DataFrame(records)
audit.to_csv(OUTPUT_AUDIT, index=False)

# =====================================================
# AGGREGATE PER BANK
# =====================================================

# pivot variables
pivot = audit.pivot_table(index="Bank", columns="Variable", values="Amount", aggfunc="sum").fillna(0)

# Build final variables
pivot["x1"] = pivot.get("x1_interest_expense", 0)
pivot["x2"] = pivot.get("x2_admin", 0) + pivot.get("x2_depr", 0) + pivot.get("x2_amor", 0)
pivot["x3"] = pivot.get("x3_total_assets", 0)
pivot["y1"] = pivot.get("y1_interest_income", 0)

# Fees: prefer net, else income - expense
net_fees = pivot.get("y2_fee_net", 0)
if (net_fees != 0).sum() > 0:
    fees = net_fees
else:
    fees = pivot.get("y2_fee_inc", 0) - pivot.get("y2_fee_exp", 0)

pivot["y2_raw"] = (
    fees
    + pivot.get("y2_trading", 0)
    + pivot.get("y2_div", 0)
)

# Non-negativity adjustment for yâ‚‚
shift = -pivot["y2_raw"].min() + 1 if pivot["y2_raw"].min() <= 0 else 0
pivot["y2"] = pivot["y2_raw"] + shift

# =====================================================
# OUTPUT FINAL DEA DATASET
# =====================================================

final = pivot[["x1","x2","x3","y1","y2"]].reset_index()
final.to_csv(OUTPUT_MAIN, index=False)

print("DONE: Dataset saved as", OUTPUT_MAIN)
print("Audit file saved as", OUTPUT_AUDIT)